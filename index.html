<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Games Planet ‚Äî Quick Order Form (Latest Gen)</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#9fb0d3; --text:#eaf1ff;
      --accent:#7c4dff; --accent2:#3ddc84; --accent3:#ffd54f;
      --chip:#1b2447; --ring: rgba(124,77,255,.35); --ring2: rgba(61,220,132,.35);
      --bad:#ff5252; --ok:#3ddc84; --warn:#ff9800;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }

    html,body{background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial,sans-serif}
    .wrap{max-width:940px;margin-inline:auto;padding:18px}
    .banner-top{position:sticky;top:0;z-index:9998;background:#000;color:#0f0;font-size:12px;font-weight:700;padding:4px 10px;overflow:hidden}
    .scroll-line{white-space:nowrap;display:inline-block;animation:scroll 28s linear infinite}
    @keyframes scroll{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

    .title{
      background:linear-gradient(270deg,red,orange,yellow,green,blue,indigo,violet,red);
      background-size:1000% 1000%;
      -webkit-background-clip:text; color:transparent;
      text-align:center;font:700 34px/1 'Orbitron',sans-serif;letter-spacing:2px;
      animation:flow 15s ease-in-out infinite;margin:14px 0 10px
    }
    @keyframes flow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    .grid{display:grid;gap:16px}
    @media(min-width:880px){.grid{grid-template-columns:1.1fr .9fr}}

    .card{
      background:var(--card);border:1px solid #1b2447;border-radius:14px;box-shadow:var(--shadow);
      padding:16px
    }
    .card h3{margin:0 0 10px;font-size:18px}
    .row{display:grid;gap:12px}
    @media(min-width:640px){.row{grid-template-columns:repeat(2,1fr)}}
    label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px}
    input,select,textarea{
      width:100%;background:#0f1733;border:1px solid #2a3a74;color:var(--text);
      border-radius:10px;padding:10px 12px;outline:none
    }
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 3px var(--ring)}
    .error{background:#2b0f14 !important;border:1px solid var(--bad)!important}

    .tip{font-size:12px;color:#a6ffc6;margin-top:6px}
    .muted{font-size:12px;color:#9fb0d3}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .pill{display:inline-block;background:#1b2447;border:1px solid #2a3a74;border-radius:999px;padding:3px 10px;font-size:12px;margin-right:6px}
    .btn{
      cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700;
      background:linear-gradient(135deg,var(--accent),#5b7cfa);color:#fff;box-shadow:0 8px 24px rgba(92,125,255,.35)
    }
    .btn.secondary{background:linear-gradient(135deg,#2e7d32,#00c853)}
    .btn.warn{background:linear-gradient(135deg,#ff8f00,#ffb300)}
    .btn.ghost{background:#172043;border:1px solid #2a3a74}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .divider{height:1px;background:#24305f;margin:14px 0}
    .arrow-bounce{font-size:22px;text-align:center;animation:bounce 1s infinite;color:#ff9800}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}

    .flash{
      display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:#28a745;color:#fff;padding:18px 28px;border-radius:12px;font:700 20px/1.2 system-ui;
      box-shadow:0 0 20px rgba(0,0,0,.4);z-index:9999;animation:blink .6s alternate ease-in-out 10
    }
    @keyframes blink{from{opacity:1}to{opacity:.2}}

    pre.out{
      white-space:pre-wrap;background:#0f1733;border:1px dashed #2a3a74;color:#eaf1ff;border-radius:12px;
      padding:12px 14px;font-size:13px
    }

    .qr-wrap{display:none;text-align:center}
    canvas{background:#fff;border-radius:8px}
  </style>
</head>
<body>
  <div class="banner-top"><span class="scroll-line">üéÆ Games Planet ‚Äî Retro to Modern Gaming ‚Ä¢ Subscribe on YouTube, share on WhatsApp & get prepaid discount coupon ‚Ä¢ Fast dispatch, helpful support</span></div>
  <div class="wrap">
    <div class="title">GAMES PLANET</div>

    <div class="grid">
      <!-- LEFT: ORDER FORM -->
      <section class="card">
        <h3>Order Details</h3>

        <!-- Product & Variant -->
        <div class="row">
          <div>
            <label>Category</label>
            <select id="category">
              <option>All</option>
              <option>Classic Retro 2D-3D</option>
              <option>Playstation 2</option>
              <option>Playstation 3</option>
              <option>Playstation 4</option>
              <option>handheld Game Console</option>
              <option>micro sd Card</option>
              <option>Accessories</option>
              <option>Game controllers</option>
              <option>storage</option>
              <option>Refurbished or Renewed Game consoles</option>
            </select>
          </div>
          <div>
            <label>Product Name <span class="pill">required</span></label>
            <select id="product">
              <option value="">Select a product</option>
              <option value="PLAYSTATION 2 SLIM">PlayStation 2 Slim</option>
              <option value="FMCB CARD + USB">FMCB Card + USB</option>
              <option value="OG GAMESTICK GD30v3 (VAYAVA)">OG GAMESTICK GD30v3 (VAYAVA)</option>
              <option value="OG GPZ M33 (VAYAVA)">OG GPZ M33 (VAYAVA)</option>
              <option value="GPZ R35S">GPZ R35S</option>
              <option value="PANDORA GAMESTICK PRO WHITEBOX">PANDORA GAMESTICK PRO WHITEBOX</option>
              <option value="MICRO SD CARD">MICRO SD CARD</option>
              <option value="other">PRODUCT NOT IN LIST</option>
            </select>
            <div id="otherWrap" style="display:none;margin-top:8px">
              <input id="otherProduct" placeholder="Type exact product name"/>
            </div>
            <div class="tip">PS2 Slim choose karte hi guide page auto open hoga.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Storage (GB)</label>
            <select id="gb">
              <option value="">Not Applicable</option>
              <option value="64">64GB</option>
              <option value="128">128GB</option>
              <option value="256">256GB</option>
              <option value="500">500GB (not for Gamestick/Gamebox)</option>
            </select>
          </div>
          <div id="ps2ModelGroup" style="display:none">
            <label>PlayStation 2 Model</label>
            <select id="ps2Model">
              <option value="">Select PS2 Model</option>
              <option>PS2 FAT</option>
              <option>PS2 Slim 70000 Series</option>
              <option selected>PS2 Slim 90000 Series</option>
            </select>
          </div>
        </div>

        <!-- PAYMENT MODE + COUPON (moved above summary) -->
        <div class="row">
          <div>
            <label>Payment Mode</label>
            <select id="paymentType">
              <option value="prepaid">Full Prepaid</option>
              <option value="cod">Cash on Delivery (‚Çπ500 or 10% advance)</option>
            </select>
          </div>
          <div id="couponGroup">
            <label>Discount Coupon <span class="muted">(Prepaid only)</span></label>
            <input id="coupon" placeholder="Enter coupon code"/>
            <div id="discountInfoBox" class="tip"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Pricing -->
        <div class="row">
          <div>
            <label>Base Price (‚Çπ) <span class="pill">editable</span></label>
            <input id="basePrice" type="number" min="0" step="1" placeholder="0"/>
          </div>
          <div>
            <label>Discount Applied (‚Çπ)</label>
            <input id="discountApplied" class="mono" type="text" value="0" readonly/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Amount Paid (‚Çπ)</label>
            <input id="amountPaid" class="mono" type="text" value="0" readonly/>
          </div>
          <div>
            <label id="restLabel">Rest on Delivery (‚Çπ)</label>
            <input id="restAmount" class="mono" type="text" value="0" readonly/>
            <div id="codChargeNote" class="muted" style="display:none"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Address -->
        <h3 style="margin-top:0">Customer & Address</h3>
        <div class="row">
          <div><label>Order ID</label><input id="orderId" placeholder="Auto/Manual"/></div>
          <div><label>Name</label><input id="custName" placeholder="Full name"/></div>
        </div>
        <div class="row">
          <div><label>Mobile</label><input id="mobile" placeholder="+91-XXXXXXXXXX"/></div>
          <div><label>Alt Mobile</label><input id="altMobile" placeholder="Optional"/></div>
        </div>
        <div class="row">
          <div><label>Email</label><input id="email" placeholder="name@email.com"/></div>
          <div><label>Landmark</label><input id="landmark" placeholder="Nearby reference"/></div>
        </div>
        <div class="row">
          <div style="grid-column:1/-1">
            <label>Address</label>
            <textarea id="address" rows="3" placeholder="House no, Street, Area..."></textarea>
          </div>
        </div>

        <div class="row">
          <div><label>Pincode</label><input id="pincode" maxlength="6" placeholder="6-digit"/></div>
          <div><label>State</label><input id="state" readonly/></div>
        </div>
        <div class="row">
          <div><label>District/City</label><input id="district" readonly/></div>
          <div>
            <label>Post Office</label>
            <select id="postOffice"><option value="">Select after pincode</option></select>
          </div>
        </div>

        <div class="stack" style="margin-top:10px">
          <button class="btn" id="btnWhatsPre">Generate Prepaid WhatsApp</button>
          <button class="btn warn" id="btnWhatsCOD">Generate COD WhatsApp</button>
          <button class="btn ghost" id="btnReset">Reset</button>
        </div>
      </section>

      <!-- RIGHT: PAYMENT + PREVIEW -->
      <section class="card">
        <h3>Pay / Preview</h3>

        <div class="row">
          <div>
            <label>Delivery Type</label>
            <select id="deliveryOption">
              <option value="standard" selected>Standard (Free)</option>
              <option value="express">Express (+‚Çπ200)</option>
            </select>
          </div>
          <div>
            <label>Distance</label>
            <input id="distanceKm" class="mono" placeholder="Auto / optional"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>ETA</label>
            <input id="etaText" class="mono" placeholder="Auto (e.g., 3‚Äì5 days)" />
          </div>
          <div>
            <label>Estimated Delivery</label>
            <input id="estDelivery" class="mono" placeholder="e.g., 02 Sep to 04 Sep" />
          </div>
        </div>

        <div class="divider"></div>

        <!-- UPI Buttons -->
        <div class="stack">
          <button class="btn secondary" id="payNowBtn">Pay ‚Çπ0</button>
          <button class="btn" id="payAltBtn">Alternate Pay ‚Çπ0</button>
        </div>
        <div class="muted" style="margin-top:6px">‚ö†Ô∏è Agar Pay Button se payment na ho to neeche QR use karein.</div>
        <div class="arrow-bounce">‚¨áÔ∏è</div>

        <!-- QR -->
        <div class="qr-wrap" id="qrSection">
          <canvas id="upiQrCanvas" width="240" height="240"></canvas>
          <div class="stack" style="justify-content:center;margin-top:8px">
            <button class="btn ghost" id="btnDownloadQR">Download QR</button>
            <button class="btn ghost" id="btnRefreshQR">Refresh QR</button>
          </div>
        </div>

        <div class="divider"></div>

        <h3>Message Preview</h3>
        <pre id="msgPreview" class="out">Your WhatsApp message will appear here‚Ä¶</pre>
      </section>
    </div>
  </div>

  <div class="flash" id="flashMessage">Congratulations! Discount applied.</div>

  <script>
    // =================== CONFIG ===================
    const UPI_ID = "";          // e.g. "your@upi"  (amount-only as per your policy)
    const ALT_UPI_ID = "";      // optional second UPI
    const COUPON_CODE = "gpz2025"; // lowercase match

    // COD rules
    const COD_MIN_ADV = 500;      // min advance
    const COD_ADV_RATE = 0.10;    // 10% of base
    const COD_EXTRA_UNDER_1500 = 99; // <1500 => +‚Çπ99

    // =================== DOM ===================
    const el = id => document.getElementById(id);

    const productEl = el('product');
    const otherWrap = el('otherWrap');
    const otherProductEl = el('otherProduct');
    const gbEl = el('gb');
    const ps2ModelGroup = el('ps2ModelGroup');

    const paymentTypeEl = el('paymentType');
    const couponGroup = el('couponGroup');
    const couponEl = el('coupon');
    const discountInfoBox = el('discountInfoBox');

    const basePriceEl = el('basePrice');
    const discountAppliedEl = el('discountApplied');
    const amountPaidEl = el('amountPaid');
    const restAmountEl = el('restAmount');
    const restLabelEl = el('restLabel');
    const codChargeNote = el('codChargeNote');

    const orderIdEl = el('orderId');
    const custNameEl = el('custName');
    const mobileEl = el('mobile');
    const altMobileEl = el('altMobile');
    const emailEl = el('email');
    const landmarkEl = el('landmark');
    const addressEl = el('address');
    const pincodeEl = el('pincode');
    const stateEl = el('state');
    const districtEl = el('district');
    const postOfficeEl = el('postOffice');

    const deliveryOptionEl = el('deliveryOption');
    const distanceKmEl = el('distanceKm');
    const etaTextEl = el('etaText');
    const estDeliveryEl = el('estDelivery');

    const btnWhatsPre = el('btnWhatsPre');
    const btnWhatsCOD = el('btnWhatsCOD');
    const btnReset = el('btnReset');
    const msgPreview = el('msgPreview');

    const payNowBtn = el('payNowBtn');
    const payAltBtn = el('payAltBtn');
    const qrSection = el('qrSection');
    const qrCanvas = el('upiQrCanvas');
    const btnDownloadQR = el('btnDownloadQR');
    const btnRefreshQR = el('btnRefreshQR');

    const flash = el('flashMessage');

    // =================== HELPERS ===================
    function showFlash(text){
      flash.textContent = text || "Done!";
      flash.style.display = 'block';
      setTimeout(()=>flash.style.display='none', 2500);
    }

    function toInt(x){ return Math.max(0, Math.round(Number(x||0))); }

    function applyCoupon(base){
      const code = (couponEl.value||"").trim().toLowerCase();
      if (paymentTypeEl.value !== 'prepaid' || !code || code !== COUPON_CODE) return 0;

      // storage-tier discount
      const gb = gbEl.value;
      let disc = 0;
      if (gb === '64') disc = 200;
      else if (gb === '128') disc = 300;
      else if (gb === '256' || Number(gb) >= 256) disc = 500;

      if (disc>0) {
        discountInfoBox.textContent = `Coupon applied: -‚Çπ${disc}`;
        showFlash("Congratulations! Discount applied.");
      } else {
        discountInfoBox.textContent = "Coupon valid, but storage not eligible for discount tier.";
      }
      return Math.min(disc, base);
    }

    function codAdvance(base){
      return Math.max(COD_MIN_ADV, Math.ceil(base * COD_ADV_RATE));
    }

    function updatePS2Visibility(){
      ps2ModelGroup.style.display = (productEl.value === 'PLAYSTATION 2 SLIM') ? 'block' : 'none';
    }

    function updateOtherProduct(){
      otherWrap.style.display = (productEl.value === 'other') ? 'block' : 'none';
    }

    // =================== PRICE ENGINE ===================
    function recalc(){
      const base = toInt(basePriceEl.value);
      let discount = 0, paid = 0, rest = 0;

      // delivery add-on
      const deliveryAdd = (deliveryOptionEl.value === 'express') ? 200 : 0;

      if (paymentTypeEl.value === 'prepaid'){
        couponGroup.style.display = 'block';
        discount = applyCoupon(base);
        paid = Math.max(0, base - discount + deliveryAdd);
        rest = 0;
        restLabelEl.textContent = "Rest on Delivery (‚Çπ)";
        codChargeNote.style.display = 'none';
      } else {
        couponGroup.style.display = 'none';
        discountInfoBox.textContent = "";
        discount = 0;
        let total = base + deliveryAdd;

        // COD extra if base < 1500
        let codExtra = (base < 1500) ? COD_EXTRA_UNDER_1500 : 0;
        total += codExtra;

        paid = codAdvance(base);  // advance only on base
        rest = Math.max(0, total - paid);
        restLabelEl.textContent = "Rest on Delivery (‚Çπ)";
        codChargeNote.style.display = 'block';
        codChargeNote.textContent = (codExtra>0) ? `Note: COD charge +‚Çπ${codExtra} (orders below ‚Çπ1500).` : `No COD charge (‚Çπ1500 and above).`;
      }

      discountAppliedEl.value = String(discount);
      amountPaidEl.value = String(paid);
      restAmountEl.value = String(rest);

      // Update UPI buttons
      payNowBtn.textContent = `Pay ‚Çπ${paid}`;
      payAltBtn.textContent = `Alternate Pay ‚Çπ${paid}`;

      // refresh QR
      drawUPIQR(paid);
    }

    // =================== PINCODE LOOKUP ===================
    async function lookupPincode(){
      const p = (pincodeEl.value||"").trim();
      if (p.length !== 6) return;
      try{
        const res = await fetch(`https://api.postalpincode.in/pincode/${p}`);
        const data = await res.json();
        if (data && data[0] && data[0].Status === "Success"){
          const list = data[0].PostOffice || [];
          if (list.length){
            stateEl.value = list[0].State || "";
            districtEl.value = list[0].District || "";
            postOfficeEl.innerHTML = "";
            list.forEach(po=>{
              const opt = document.createElement('option');
              opt.value = po.Name; opt.textContent = po.Name;
              postOfficeEl.appendChild(opt);
            });
          }
        } else {
          alert("Pincode not found.");
        }
      }catch(e){
        alert("Failed to fetch pincode details.");
      }
    }

    // =================== UPI PAYMENT ===================
    function upiLink(amount, alt=false){
      const pa = alt ? ALT_UPI_ID : UPI_ID;
      // amount-only, no payee name
      const a = Number(amount||0).toFixed(2);
      if(!pa){
        return `upi://pay?am=${encodeURIComponent(a)}`;
      }
      return `upi://pay?pa=${encodeURIComponent(pa)}&am=${encodeURIComponent(a)}`;
    }

    function openUPI(amount, alt=false){
      const link = upiLink(amount, alt);
      window.location.href = link;
    }

    // Basic QR (numeric squares) ‚Äî minimal for UPI string
    function drawUPIQR(amount){
      try{
        const ctx = qrCanvas.getContext('2d');
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,qrCanvas.width,qrCanvas.height);
        // Simple fallback QR-esque pattern (not true QR). Replace with real QR lib if needed.
        // To avoid broken UX, we render the UPI text below.
        ctx.fillStyle = '#000';
        ctx.font = '12px monospace';
        const text = upiLink(amount);
        wrapText(ctx, text, 10, 20, 220, 16);
        qrSection.style.display = 'block';
      }catch(e){
        qrSection.style.display = 'none';
      }
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight){
      const words = text.split(' ');
      let line = '';
      for(let n=0;n<words.length;n++){
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        if (metrics.width > maxWidth && n>0){
          ctx.fillText(line, x, y);
          line = words[n] + ' ';
          y += lineHeight;
        } else {
          line = testLine;
        }
      }
      ctx.fillText(line, x, y);
    }

    function downloadCanvas(canvas, filename='upi-qr.png'){
      const link = document.createElement('a');
      link.download = filename;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    // =================== ETA SIMPLE LOGIC ===================
    function computeETA(){
      // If user filled custom ETA/dates, keep. Otherwise quick defaults.
      if(!etaTextEl.value){
        const isCOD = paymentTypeEl.value === 'cod';
        etaTextEl.value = isCOD ? '4‚Äì7 days (COD +2 days)' : '3‚Äì5 days';
      }
      if(!estDeliveryEl.value){
        // rough window +3 to +5 days (prepaid), +2 extra for COD
        const today = new Date();
        const addA = paymentTypeEl.value==='cod' ? 4 : 3;
        const addB = paymentTypeEl.value==='cod' ? 7 : 5;
        const a = new Date(today); a.setDate(a.getDate()+addA);
        const b = new Date(today); b.setDate(b.getDate()+addB);
        const fmt = d => d.toLocaleDateString('en-IN',{day:'2-digit',month:'short'});
        estDeliveryEl.value = `${fmt(a)} to ${fmt(b)}`;
      }
    }

    // =================== WHATSAPP MESSAGE ===================
    function buildMsg(isPrepaid=true){
      const pName = (productEl.value==='other' ? (otherProductEl.value||'') : productEl.value) || '';
      const variant = gbEl.value ? (gbEl.value+'GB') : '';

      const fields = {
        orderId: orderIdEl.value || '',
        name: (custNameEl.value||'').trim(),
        mobile: mobileEl.value || '',
        alt: altMobileEl.value || '',
        email: emailEl.value || '',
        address: addressEl.value || '',
        landmark: landmarkEl.value || '',
        pincode: pincodeEl.value || '',
        state: stateEl.value || '',
        district: districtEl.value || '',
        postOffice: postOfficeEl.value || '',
        product: pName,
        variant: variant,
        base: toInt(basePriceEl.value),
        discount: toInt(discountAppliedEl.value),
        paid: toInt(amountPaidEl.value),
        rest: toInt(restAmountEl.value),
        distance: distanceKmEl.value || '',
        eta: etaTextEl.value || '',
        delivery: estDeliveryEl.value || ''
      };

      const lines = [];
      if (isPrepaid){
        lines.push('üü¢ Prepaid Order on WhatsApp','');
      } else {
        lines.push('üî¥ COD Order on WhatsApp','');
      }
      lines.push(
        `Order ID: ${fields.orderId}`,
        `Name: ${fields.name}`,
        `Mobile: ${fields.mobile}`,
        `Alt Mobile: ${fields.alt}`,
        `Email: ${fields.email}`,
        `Address: ${fields.address}`,
        `Landmark: ${fields.landmark}`,
        `Pincode: ${fields.pincode}`,
        `State: ${fields.state}`,
        `District/City: ${fields.district}`,
        `Post office: ${fields.postOffice}`,
        ``,
        `Product: ${fields.product}`,
        `Variant: ${fields.variant}`,
        `Base Price: ‚Çπ ${fields.base}`,
        `Discount Applied: ‚Çπ ${fields.discount}`,
        `Amount Paid: ‚Çπ ${fields.paid}`
      );

      if (!isPrepaid){
        lines.push(`Rest on Delivery: ‚Çπ ${fields.rest}`);
      }

      lines.push(
        ``,
        `üìè Distance: ${fields.distance}`,
        `${isPrepaid ? '‚è≥ Prepaid Order ETA' : '‚è≥ COD Order ETA'}: ${fields.eta}`,
        `üìÖ Estimated Delivery: ${fields.delivery}`,
        `Delivery Circumstances and conditions:`
      );

      return lines.join('\n');
    }

    function updatePreview(){
      const isPre = (paymentTypeEl.value==='prepaid');
      msgPreview.textContent = buildMsg(isPre);
    }

    function openWhatsApp(isPrepaid=true){
      const text = encodeURIComponent(buildMsg(isPrepaid));
      // redirect to your business number chat; replace with your wa.me if needed:
      window.open(`https://wa.me/917983624797?text=${text}`,'_blank');
    }

    // =================== EVENTS ===================
    productEl.addEventListener('change', ()=>{
      updatePS2Visibility();
      updateOtherProduct();
      if (productEl.value==='PLAYSTATION 2 SLIM'){
        window.open("https://gamesplanet13.github.io/ps2/","_blank");
      }
      recalc(); updatePreview();
    });

    gbEl.addEventListener('change', ()=>{ recalc(); updatePreview(); });
    paymentTypeEl.addEventListener('change', ()=>{ recalc(); updatePreview(); computeETA(); });
    couponEl.addEventListener('input', ()=>{ recalc(); updatePreview(); });
    basePriceEl.addEventListener('input', ()=>{ recalc(); updatePreview(); });
    deliveryOptionEl.addEventListener('change', ()=>{ recalc(); updatePreview(); computeETA(); });

    pincodeEl.addEventListener('input', ()=>{
      if (pincodeEl.value.trim().length===6) lookupPincode();
    });

    [orderIdEl,custNameEl,mobileEl,altMobileEl,emailEl,landmarkEl,addressEl,stateEl,districtEl,postOfficeEl,distanceKmEl,etaTextEl,estDeliveryEl]
      .forEach(n => n.addEventListener('input', updatePreview));

    btnWhatsPre.addEventListener('click', ()=>openWhatsApp(true));
    btnWhatsCOD.addEventListener('click', ()=>openWhatsApp(false));
    btnReset.addEventListener('click', ()=>{
      document.querySelectorAll('input,textarea,select').forEach(i=>{
        if(i===paymentTypeEl) return;
        if(i.type==='text'||i.tagName==='TEXTAREA'||i.type==='number') i.value='';
        if(i.tagName==='SELECT') i.selectedIndex=0;
      });
      paymentTypeEl.value='prepaid';
      discountInfoBox.textContent='';
      recalc(); computeETA(); updatePreview();
    });

    payNowBtn.addEventListener('click', ()=>openUPI(amountPaidEl.value,false));
    payAltBtn.addEventListener('click', ()=>openUPI(amountPaidEl.value,true));
    btnDownloadQR.addEventListener('click', ()=>downloadCanvas(qrCanvas));
    btnRefreshQR.addEventListener('click', ()=>drawUPIQR(toInt(amountPaidEl.value)));

    // =================== INIT ===================
    window.addEventListener('DOMContentLoaded', ()=>{
      // defaults
      paymentTypeEl.value = 'prepaid';
      couponGroup.style.display = 'block';
      computeETA();
      recalc();
      updatePreview();
    });
  </script>
</body>
</html>
